<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MobileConfig WebClip Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 1em;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px #ccc;
    }
    h1 {
      color: #007aff;
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    .webclip {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 6px;
      background: #fafafa;
    }
    .note {
      font-size: 0.85em;
      color: #888;
      margin-top: 10px;
    }
    .icon-preview {
      margin-top: 5px;
      max-width: 100px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebClip Profile Generator</h1>

    <label>Profile Display Name</label>
    <input type="text" id="profileName" value="My WebClips">

    <div id="webclipsContainer"></div>
    <button onclick="addWebClip()">Add WebClip</button>

    <div class="note">Icons will be uploaded to Supabase and used in the profile. Profile must be installed to show locked bookmarks.</div>

    <button onclick="generateProfile()">Download Profile</button>
  </div>

  <script>
    const SUPABASE_URL = 'https://hwqvzeilsvzhwiioojwe.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cXZ6ZWlsc3Z6aHdpaW9vandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNzkwNTksImV4cCI6MjA2OTg1NTA1OX0.a3WoFihER-u9BNqtguvVz-w08szpsYxTqIYEI9pyZ4I';

    const webclipsContainer = document.getElementById('webclipsContainer');

    function addWebClip() {
      const index = document.querySelectorAll('.webclip').length;
      const div = document.createElement('div');
      div.className = 'webclip';
      div.innerHTML = `
        <label>WebClip Title</label>
        <input type="text" placeholder="Title" id="title${index}">

        <label>URL</label>
        <input type="url" placeholder="https://example.com" id="url${index}">

        <label>Upload Icon (PNG)</label>
        <input type="file" accept="image/png" id="icon${index}" onchange="uploadIcon(event, ${index})">

        <img id="preview${index}" class="icon-preview" src="" style="display:none">
        <input type="hidden" id="iconUrl${index}">
      `;
      webclipsContainer.appendChild(div);
    }

    async function uploadIcon(event, index) {
      const file = event.target.files[0];
      if (!file) return;

      const fileName = `icon-${Date.now()}-${index}.png`;
      const formData = new FormData();
      formData.append('file', file);

      const res = await fetch(`${SUPABASE_URL}/storage/v1/object/images/${fileName}`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${SUPABASE_KEY}`,
          'x-upsert': 'true'
        },
        body: file
      });

      if (res.ok) {
        const iconUrl = `${SUPABASE_URL}/storage/v1/object/public/images/${fileName}`;
        document.getElementById(`iconUrl${index}`).value = iconUrl;
        const preview = document.getElementById(`preview${index}`);
        preview.src = iconUrl;
        preview.style.display = 'block';
      } else {
        alert("Upload failed.");
      }
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function generateProfile() {
      const profileName = document.getElementById('profileName').value;
      const clips = document.querySelectorAll('.webclip');
      const payloads = [];

      clips.forEach((clip, i) => {
        const title = document.getElementById(`title${i}`).value;
        const url = document.getElementById(`url${i}`).value;
        const icon = document.getElementById(`iconUrl${i}`).value;

        if (title && url) {
          payloads.push({
            PayloadType: "com.apple.webClip.managed",
            PayloadVersion: 1,
            PayloadIdentifier: `com.example.webclip.${i}`,
            PayloadUUID: generateUUID(),
            PayloadDisplayName: title,
            Label: title,
            URL: url,
            IsRemovable: false,
            Icon: icon ? null : undefined,
            Precomposed: true,
            FullScreen: true,
            IconURL: icon || undefined
          });
        }
      });

      const profile = {
        PayloadType: "Configuration",
        PayloadVersion: 1,
        PayloadIdentifier: `com.example.webclips`,
        PayloadUUID: generateUUID(),
        PayloadDisplayName: profileName,
        PayloadContent: payloads
      };

      const xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
 "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
${convertToXML(profile)}
</plist>`;

      const blob = new Blob([xml], { type: 'application/x-apple-aspen-config' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = profileName.replace(/\s+/g, '_').toLowerCase() + ".mobileconfig";
      a.click();
    }

    function convertToXML(obj, indent = '  ') {
      if (typeof obj !== 'object' || obj === null) return '';
      let xml = '<dict>\n';
      for (const key in obj) {
        const val = obj[key];
        xml += indent + `<key>${key}</key>\n`;
        if (typeof val === 'string') {
          xml += indent + `<string>${val}</string>\n`;
        } else if (typeof val === 'number') {
          xml += indent + `<integer>${val}</integer>\n`;
        } else if (typeof val === 'boolean') {
          xml += indent + `<${val}/>\n`;
        } else if (Array.isArray(val)) {
          xml += indent + `<array>\n`;
          val.forEach(item => {
            if (typeof item === 'string') {
              xml += indent + indent + `<string>${item}</string>\n`;
            } else {
              xml += indent + indent + convertToXML(item, indent + '  ') + '\n';
            }
          });
          xml += indent + `</array>\n`;
        } else if (typeof val === 'object') {
          xml += indent + convertToXML(val, indent + '  ') + '\n';
        }
      }
      xml += '</dict>';
      return xml;
    }

    // Add default one on load
    addWebClip();
  </script>
</body>
</html>
