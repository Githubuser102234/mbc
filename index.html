<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MobileConfig Generator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 1em;
      background: #f4f4f4;
      color: #333;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
    }
    h1 {
      color: #007aff;
    }
    label {
      font-weight: bold;
      margin-top: 15px;
      display: block;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
    }
    .webclip {
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 15px;
      border-radius: 6px;
    }
    img.preview {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-top: 5px;
      display: none;
    }
    button {
      background: #007aff;
      color: white;
      border: none;
      margin-top: 20px;
      cursor: pointer;
    }
    button:hover {
      background: #005bb5;
    }
    .note {
      color: #888;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>MobileConfig Generator</h1>

    <label>Profile Name</label>
    <input type="text" id="profileName" value="My Profile" />

    <label>Wi-Fi SSID (optional)</label>
    <input type="text" id="wifiSSID" placeholder="MyWiFi" />

    <label>Wi-Fi Password (optional)</label>
    <input type="password" id="wifiPassword" placeholder="password123" />

    <div id="webclipList"></div>
    <button onclick="addWebClip()">Add WebClip (Home Screen Bookmark)</button>

    <button onclick="generateProfile()">Download Profile</button>
  </div>

  <script>
    const SUPABASE_URL = "https://hwqvzeilsvzhwiioojwe.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3cXZ6ZWlsc3Z6aHdpaW9vandlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNzkwNTksImV4cCI6MjA2OTg1NTA1OX0.a3WoFihER-u9BNqtguvVz-w08szpsYxTqIYEI9pyZ4I";

    let webclipCount = 0;

    function addWebClip() {
      const container = document.createElement("div");
      container.className = "webclip";
      container.innerHTML = `
        <label>Bookmark Title</label>
        <input type="text" id="clipTitle${webclipCount}" placeholder="Example Site" />

        <label>Bookmark URL</label>
        <input type="url" id="clipURL${webclipCount}" placeholder="https://example.com" />

        <label>Icon Upload (PNG or JPG)</label>
        <input type="file" accept="image/*" onchange="uploadIcon(event, ${webclipCount})" />
        <img class="preview" id="preview${webclipCount}" />

        <input type="hidden" id="iconBase64${webclipCount}" />
      `;
      document.getElementById("webclipList").appendChild(container);
      webclipCount++;
    }

    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    async function uploadIcon(event, index) {
      const file = event.target.files[0];
      if (!file) return;

      // Preview
      const reader = new FileReader();
      reader.onload = async function () {
        const base64 = reader.result.split(',')[1];
        document.getElementById(`iconBase64${index}`).value = base64;

        const preview = document.getElementById(`preview${index}`);
        preview.src = reader.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);

      // Upload to Supabase (optional, can be skipped)
      const fileName = `icon-${Date.now()}-${index}.png`;
      const res = await fetch(`${SUPABASE_URL}/storage/v1/object/images/${fileName}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/octet-stream',
          'x-upsert': 'true'
        },
        body: file
      });

      if (!res.ok) {
        const error = await res.text();
        alert("Upload failed: " + error);
        console.error(error);
      }
    }

    function convertToXML(obj, indent = '  ') {
      let xml = '<dict>\n';
      for (const key in obj) {
        const val = obj[key];
        xml += indent + `<key>${key}</key>\n`;

        if (val && typeof val === 'object' && val.__base64) {
          xml += indent + `<data>${val.__base64}</data>\n`;
        } else if (typeof val === 'string') {
          xml += indent + `<string>${val}</string>\n`;
        } else if (typeof val === 'number') {
          xml += indent + `<integer>${val}</integer>\n`;
        } else if (typeof val === 'boolean') {
          xml += indent + `<${val}/>\n`;
        } else if (Array.isArray(val)) {
          xml += indent + `<array>\n`;
          val.forEach(item => {
            xml += indent + indent + convertToXML(item, indent + '  ') + '\n';
          });
          xml += indent + `</array>\n`;
        } else if (typeof val === 'object' && val !== null) {
          xml += indent + convertToXML(val, indent + '  ') + '\n';
        }
      }
      xml += '</dict>';
      return xml;
    }

    function generateProfile() {
      const profileName = document.getElementById('profileName').value.trim();
      const wifiSSID = document.getElementById('wifiSSID').value.trim();
      const wifiPassword = document.getElementById('wifiPassword').value.trim();

      const payloads = [];

      if (wifiSSID && wifiPassword) {
        payloads.push({
          PayloadType: "com.apple.wifi.managed",
          SSID_STR: wifiSSID,
          HiddenNetwork: false,
          AutoJoin: true,
          EncryptionType: "WPA",
          Password: wifiPassword,
          PayloadDisplayName: "Wi-Fi Config",
          PayloadIdentifier: "com.example.wifi",
          PayloadUUID: generateUUID(),
          PayloadVersion: 1
        });
      }

      for (let i = 0; i < webclipCount; i++) {
        const title = document.getElementById(`clipTitle${i}`)?.value.trim();
        const url = document.getElementById(`clipURL${i}`)?.value.trim();
        const base64 = document.getElementById(`iconBase64${i}`)?.value.trim();

        if (title && url) {
          const clipPayload = {
            PayloadType: "com.apple.webClip.managed",
            PayloadVersion: 1,
            PayloadIdentifier: `com.example.webclip.${generateUUID()}`,
            PayloadUUID: generateUUID(),
            PayloadDisplayName: title,
            Label: title,
            URL: url,
            IsRemovable: false,
            Precomposed: true,
            FullScreen: true
          };

          if (base64) {
            clipPayload.Icon = { __base64: base64 };
          }

          payloads.push(clipPayload);
        }
      }

      const profile = {
        PayloadType: "Configuration",
        PayloadVersion: 1,
        PayloadIdentifier: "com.example." + generateUUID().slice(0, 8),
        PayloadUUID: generateUUID(),
        PayloadDisplayName: profileName,
        PayloadContent: payloads
      };

      const xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
 "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
${convertToXML(profile)}
</plist>`;

      const blob = new Blob([xml], { type: 'application/x-apple-aspen-config' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = profileName.replace(/\s+/g, '_').toLowerCase() + ".mobileconfig";
      a.click();
    }
  </script>
</body>
</html>